<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLB Standings Race (2025)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600 dark:text-blue-400">MLB Standings Race (2025)</h1>
            <p id="chart-subtitle" class="mt-2 text-lg text-gray-600 dark:text-gray-400">Tracking team performance based on historical game-by-game results.</p>
        </header>

        <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 min-h-[500px] flex flex-col justify-center">
            <div id="controls" class="mb-6 flex-col sm:flex-row items-center justify-between hidden">
                <label for="division-select" class="font-semibold text-lg mb-2 sm:mb-0">Select Race:</label>
                <select id="division-select" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto">
                    <option value="AL East">AL East</option>
                    <option value="AL Central">AL Central</option>
                    <option value="AL West">AL West</option>
                    <option value="NL East">NL East</option>
                    <option value="NL Central">NL Central</option>
                    <option value="NL West">NL West</option>
                    <option value="AL Wild Card">AL Wild Card</option>
                    <option value="NL Wild Card">NL Wild Card</option>
                </select>
            </div>
            <div id="loader-container" class="text-center">
                <div class="loader mx-auto"></div>
                <p id="loader-text" class="mt-4 text-lg font-semibold">Fetching historical game data...</p>
            </div>
            <div id="error-message" class="text-center hidden">
                 <p class="text-red-500 font-bold text-xl">Could not fetch historical game data.</p>
                 <p class="text-gray-600 dark:text-gray-400 mt-2">There was an issue retrieving the full season history. Please try again later.</p>
            </div>
            <div class="chart-container relative h-96 md:h-[500px]">
                <canvas id="standingsChart"></canvas>
            </div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400">
            <p>Data sourced from public sports APIs. Chart created using Chart.js.</p>
        </footer>
    </div>

    <script>
        const teams = {
            "AL East": { "BAL": { name: "Baltimore Orioles", color: "#DF4601" }, "BOS": { name: "Boston Red Sox", color: "#BD3039" }, "NYY": { name: "New York Yankees", color: "#003087" }, "TB": { name: "Tampa Bay Rays", color: "#8FBCE6" }, "TOR": { name: "Toronto Blue Jays", color: "#134A8E" } },
            "AL Central": { "CHW": { name: "Chicago White Sox", color: "#27251F" }, "CLE": { name: "Cleveland Guardians", color: "#E31937" }, "DET": { name: "Detroit Tigers", color: "#0C2340" }, "KC": { name: "Kansas City Royals", color: "#004687" }, "MIN": { name: "Minnesota Twins", color: "#002B5C" } },
            "AL West": { "HOU": { name: "Houston Astros", color: "#EB6E1F" }, "LAA": { name: "Los Angeles Angels", color: "#BA0021" }, "ATH": { name: "Athletics", color: "#003831" }, "SEA": { name: "Seattle Mariners", color: "#0C2C56" }, "TEX": { name: "Texas Rangers", color: "#003278" } },
            "NL East": { "ATL": { name: "Atlanta Braves", color: "#CE1141" }, "MIA": { name: "Miami Marlins", color: "#00A3E0" }, "NYM": { name: "New York Mets", color: "#FF5910" }, "PHI": { name: "Philadelphia Phillies", color: "#E81828" }, "WSH": { name: "Washington Nationals", color: "#AB0003" } },
            "NL Central": { "CHC": { name: "Chicago Cubs", color: "#0E3386" }, "CIN": { name: "Cincinnati Reds", color: "#C6011F" }, "MIL": { name: "Milwaukee Brewers", color: "#12284B" }, "PIT": { name: "Pittsburgh Pirates", color: "#FDB827" }, "STL": { name: "St. Louis Cardinals", color: "#C41E3A" } },
            "NL West": { "ARI": { name: "Arizona Diamondbacks", color: "#A71930" }, "COL": { name: "Colorado Rockies", color: "#33006F" }, "LAD": { name: "Los Angeles Dodgers", color: "#005A9C" }, "SD": { name: "San Diego Padres", color: "#2F241D" }, "SF": { name: "San Francisco Giants", color: "#FD5A1E" } }
        };
        const allTeamData = Object.values(teams).reduce((acc, div) => ({...acc, ...div}), {});
        const allTeamKeys = Object.keys(allTeamData);

        let standingsChart;
        let dailyData;
        const divisionSelect = document.getElementById('division-select');
        const ctx = document.getElementById('standingsChart').getContext('2d');
        const loaderContainer = document.getElementById('loader-container');
        const loaderText = document.getElementById('loader-text');
        const controls = document.getElementById('controls');
        const errorMessage = document.getElementById('error-message');
        const chartSubtitle = document.getElementById('chart-subtitle');

        function formatDateForAPI(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}${mm}${dd}`;
        }
        
        async function fetchAndBuildDailyStandings() {
            const dailyStandings = {};
            const currentRecords = allTeamKeys.reduce((acc, team) => {
                acc[team] = { w: 0, l: 0 };
                return acc;
            }, {});

            const startDate = new Date('2025-03-27');
            const endDate = new Date();

            try {
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStringForAPI = formatDateForAPI(d);
                    const dateStringForChart = d.toISOString().split('T')[0];
                    
                    loaderText.textContent = `Fetching game data for ${d.toLocaleDateString()}...`;

                    const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard?dates=${dateStringForAPI}`);
                    if (!response.ok) {
                        console.warn(`Could not fetch data for ${dateStringForAPI}. Skipping day.`);
                        dailyStandings[dateStringForChart] = JSON.parse(JSON.stringify(currentRecords));
                        continue;
                    }
                    const data = await response.json();

                    if (data.events && data.events.length > 0) {
                        data.events.forEach(game => {
                            const competitors = game.competitions[0].competitors;
                            const homeTeam = competitors.find(t => t.homeAway === 'home');
                            const awayTeam = competitors.find(t => t.homeAway === 'away');

                            if (homeTeam && awayTeam && (homeTeam.winner || awayTeam.winner)) {
                                // Robustness fix: Normalize abbreviations to uppercase
                                const homeAbbrev = homeTeam.team.abbreviation.toUpperCase();
                                const awayAbbrev = awayTeam.team.abbreviation.toUpperCase();
                                
                                if (homeTeam.winner) {
                                    if(currentRecords[homeAbbrev]) currentRecords[homeAbbrev].w++;
                                    if(currentRecords[awayAbbrev]) currentRecords[awayAbbrev].l++;
                                } else {
                                    if(currentRecords[awayAbbrev]) currentRecords[awayAbbrev].w++;
                                    if(currentRecords[homeAbbrev]) currentRecords[homeAbbrev].l++;
                                }
                            }
                        });
                    }
                    dailyStandings[dateStringForChart] = JSON.parse(JSON.stringify(currentRecords));
                }
                return dailyStandings;
            } catch (error) {
                console.error("A critical error occurred during data fetching:", error);
                errorMessage.classList.remove('hidden');
                throw new Error("Failed to build historical data.");
            }
        }
        
        function getWinPct(record) {
            const games = record.w + record.l;
            return games === 0 ? 0 : record.w / games;
        }

        function createChart(race) {
            if (standingsChart) standingsChart.destroy();

            const isWildCard = race.includes('Wild Card');
            const dates = Object.keys(dailyData).sort();
            
            let teamKeysToShow;

            if (isWildCard) {
                chartSubtitle.textContent = "Tracking Wild Card contender performance vs. a .500 record.";
                
                const league = race.startsWith('AL') ? 'AL' : 'NL';
                const leagueDivisions = Object.keys(teams).filter(d => d.startsWith(league));
                const leagueTeams = leagueDivisions.flatMap(d => Object.keys(teams[d]));

                const latestDate = dates[dates.length - 1];
                if (!latestDate) return; // No data yet

                const latestRecords = leagueTeams.map(t => ({ abbrev: t, ...dailyData[latestDate][t] }));
                
                const divisionWinnersLatest = leagueDivisions.map(div => 
                    Object.keys(teams[div]).map(t_abbrev => latestRecords.find(r => r.abbrev === t_abbrev))
                                           .sort((a,b) => getWinPct(b) - getWinPct(a))[0].abbrev
                );

                teamKeysToShow = latestRecords
                    .filter(t => !divisionWinnersLatest.includes(t.abbrev))
                    .sort((a,b) => getWinPct(b) - getWinPct(a))
                    .slice(0, 6) // Show top 6 contenders
                    .map(t => t.abbrev);

            } else { // Division Race
                chartSubtitle.textContent = "Tracking team performance vs. a .500 record.";
                teamKeysToShow = Object.keys(teams[race]);
            }
            
            const datasets = teamKeysToShow.map(teamKey => {
                const teamData = dates.map(date => ({
                    x: date,
                    y: dailyData[date][teamKey].w - dailyData[date][teamKey].l
                }));
                return {
                    label: allTeamData[teamKey].name,
                    data: teamData,
                    borderColor: allTeamData[teamKey].color,
                    tension: 0.1,
                    borderWidth: 2.5,
                    pointRadius: 0,
                    fill: false,
                };
            });

            const yAxisTitle = 'Games Above/Below .500';
            const annotationLabel = '.500 Record';
            
            standingsChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    scales: {
                        x: { type: 'time', time: { unit: 'month', tooltipFormat: 'MMM dd, yyyy' }, title: { display: true, text: 'Date' } },
                        y: { title: { display: true, text: yAxisTitle } }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'rectRounded', padding: 20 } },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const team = context.dataset.label;
                                    const value = context.parsed.y;
                                    const sign = value >= 0 ? '+' : '';
                                    return `${team}: ${sign}${value} Games vs .500`;
                                }
                            }
                        },
                        annotation: { annotations: { line: { type: 'line', yMin: 0, yMax: 0, borderColor: 'rgba(239, 68, 68, 0.7)', borderWidth: 2, borderDash: [6, 6], label: { content: annotationLabel, enabled: true, position: 'start', backgroundColor: 'rgba(239, 68, 68, 0.7)' } } } }
                    },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }
        
        async function initializeApp() {
            try {
                dailyData = await fetchAndBuildDailyStandings();
                
                loaderContainer.classList.add('hidden');
                controls.classList.remove('hidden');
                controls.classList.add('flex');

                const annotationPluginScript = document.createElement('script');
                annotationPluginScript.src = 'https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js';
                annotationPluginScript.onload = () => createChart(divisionSelect.value);
                document.head.appendChild(annotationPluginScript);

                divisionSelect.addEventListener('change', (event) => createChart(event.target.value));
            } catch (e) {
                loaderContainer.classList.add('hidden');
            }
        }

        initializeApp();
    </script>
</body>
</html>

